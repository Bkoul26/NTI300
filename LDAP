#!/bin/bash

yum install -y git
cd /tmp
git clone https://github.com/Bkoul26/NTI300

yum install -y openldap-servers openldap-clients

cp /usr/share/openldap-servers/DB_CONFIG.example /var/lib/ldap/DB_CONFIG
chown ldap. /var/lib/ldap/DB_CONFIG

systemctl enable slapd
systemctl start slapd

yum install -y httpd phpldapadmin

#SELinux pass
setsebool -P httpd_can_connect_ldap on

systemctl enable httpd
systemctl start httpd

sed -i ‘s,Require local,Require local\n   Require all granted,g’ /etc/httpd/conf.d/phpldapadmin.conf

#CONTINUED...

unalias cp
cp /etc/phpldapadmin/config.php /etc/phpldapadmin/config.php.orig	
# copies original CONFIGURATION file as backup

grep 'config.*blowfish' /etc/phpldapadmin/config.php.orig
# grep for blowfish key should output "# Autogenerated for ldap"

rightkey=$( grep ‘config.*blowfish’ /etc/phpldapadmin/config.php.orig )
# use rejex to retrieve the key

cp /tmp/NTI300/CONFIG /etc/phpldapadmin/config.php 
# copy pre-made conf to config.php

#sed -i “s/\$config->custom->session\[‘blowfish’\] = ‘6ad4614a5189aaf046e2057e7870ae4‘\;incomplete
sed -i "s/\$config->custom->session\['blowfish'\] = '6ad4614a51893aaf046e2057e7870ae4'\;  # Autogenerated for ldap-c/$rightkey/g" /etc/phpldapadmin/config.php
# Autogenerated for ldap-c/$rightkey/
# grep 'config.*blowfish' /etc/phpldapadmin/config.php.orig
# grep for blowfish key should output "# Autogenerated for ldap"

chown ldap:apache /etc/phpldapadmin/config.php #change to apache to make ldap with control w permissions

systemctl restart httpd #restart


echo "phpldapadmin should now be functional" #messaging for logs echo commands
echo "configuring ldap + ldapadmin"


# securely generate code with new pwd stores
newsecret=$(slappasswd -g) #system variable 'newsecret'
echo $newsecret #shows the pwd
newhash=$(slappasswd -s "$newsecret") #create a new hash of the passwd
echo $newhash #echo the hash encryption
echo -n "$newsecret" > /root/ldap_admin_pass #put pwd in root so that it can be accessed according to privelages
chmod 0600 /root/ldap_admin_pass #only root can read & write

echo -e "dn: olcDatabase={2}hdb,cn=config
changetype: modify
replace: olcSuffix          
olcSuffix: dc=NTI310,dc=local
\n
dn: olcDatabase={2}hdb,cn=config
changetype: modify
replace: olcRootDN
olcRootDN: cn=ldapadm,dc=NTI310,dc=local
\n
dn: olcDatabase={2}hdb,cn=config
changetype: modify
replace: olcRootPW
olcRootPW: $newhash" > db.ldif
#moving into db.ldif file, vim into it to make sure

vim db.ldif #make sure the code is there

ldapmodify -Y EXTERNAL  -H ldapi:/// -f db.ldif  

# Authentication Restriction

echo ’dn: olcDatabase={1}monitor,cn=config
changetype: modify
replace: olcAccess
olcAccess: {0}to * by dn.base=”gidNumber=0+uidNumber=0,cn=peercred,cn=external, cn=auth“ read by dn.base=”cn=ldapadm,dc=NTI310,
#MODIFY NEXT
ldapmodify -Y EXTERNAL  -H ldapi:/// -f monitor.ldif

# Cert Gen

openssl req -new -x509 -nodes -out /etc/openldap/certs/NTI310ldapcert.pem -keyout /etc/openldap/certs/NTI310ldapkey.pem -days 365 -subj "/C=US/ST=WA/L=Seattle/O=SCC/OU=IT/CN=NTI310.local"

chown -R ldap. /etc/openldap/certs/NTI*.pem

echo -e "dn: cn=config
changetype: modify
replace: olcTLSCertificateKeyFile
olcTLSCertificateKeyFile: /etc/openldap/certs/NTI310ldapkey.pem
\n
dn: cn=config
changetype=modify
replace: olcTLSCertificateKeyFile
olcTLSCertificateKeyFile: /etc/openldap/certs/NTI310ldapcert.pem" > certs.ldif

ldapmodify -Y EXTERNAL  -H ldapi:/// -f certs.ldif

# Cert Configurations' SLAPTEST
slaptest -u
echo “WE ARE IN BUSINESS”

#unalias cp

ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/cosine.ldif
ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/nis.ldif
ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/inetorgperson.ldif

# Dome Structure Creation for Object oriented classes

echo -e "dn: dc=NTI310,dc=local
dc: NTI310
objectClass: top
objectClass: domain
\n
#engage organzational role class for managment of LDAP
dn: cn=ldapadm,dc=NTI310,dc=local
objectClass: organizationalRole
cn: ldapadm
description: LDAP Manager
\n
#adapt organizational unit people
dn: ou=People,dc=NTI310,dc=local
objectClass: organizationalUnit
ou: People
\n
#engage organizational unit group
dn: ou=Group,dc=NTI310,dc=local
objectClass: organizationalUnit
ou: Group" > base.ldif

setenforce 0

ldapadd -x -W -D "cn=ldapadm,dc=NTI310,dc=local" -f base.ldif -y /root/ldap_admin_pass #ADD ENTRY/ this works without errors
#restart
systemctl restart httpd
#end
#cat /root/ldap_admin_pass
